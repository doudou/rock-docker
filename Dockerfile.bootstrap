<% if image.docker_tag_name.empty? %>
FROM <%= image.docker_name %>
<% else %>
FROM <%= image.docker_name %>:<%= image.docker_tag_name %>
<% end %>
RUN <%= package_manager[0] %>
RUN <%= package_manager[1] % [ruby[0]] %>
RUN <%= package_manager[1] % ['sudo'] %>
RUN groupadd rock 
RUN useradd -m -g rock -G rock,users rock
RUN echo "rock ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/rock ; chmod 0440 /etc/sudoers.d/rock
RUN echo "Defaults !requiretty" >> /etc/sudoers.d/rock

# There is a weird bug in docker (or aufs ?). Running mkdir after USER sometimes
# sets the ownership of the directory to root:root
RUN mkdir /home/rock/dev ; chown rock:rock /home/rock/dev

USER rock
ENV HOME /home/rock
WORKDIR /home/rock/dev
<% if dev_mode %>
ADD ressources/autoproj_bootstrap-dev /home/rock/dev/autoproj_bootstrap
<% else %>
ADD ressources/autoproj_bootstrap /home/rock/dev/autoproj_bootstrap
<% end %>
RUN AUTOPROJ_OSDEPS_MODE=all AUTOPROJ_BOOTSTRAP_IGNORE_NONEMPTY_DIR=1 <%= ruby[1] %> autoproj_bootstrap <%= dev_mode ? 'dev' : '' %> --no-color --no-progress git git://gitorious.org/rock/buildconf.git
